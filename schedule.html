<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    body {
      font-size: 12pt !important;
      color: #efefef !important;
      background-color: #1e1e1e !important;
    }

    .text-dim {
      color: #9b9b9b !important;
    }

    .text-smaller {
      font-size: .75rem !important;
    }

    .bg-dim {
      background-color: #181818 !important;
    }

    .bg-main {
      background-color: #1e1e1e !important;
    }

    #tblGames .hide {
      display: none !important;
      height: 0 !important;
      border: 0 !important;
    }

    #filterCont button.active {
      color: #efefef !important;
      opacity: 1 !important;
      font-weight: 700 !important;
    }
  </style>
</head>

<body style="margin-bottom: 160px;">
  <div class="container mx-auto px-0" style="max-width: 600px;">
    <div class="mx-1">
      <div id="filterCont" class="btn-group d-flex flex-nowrap overflow-x-scroll" role="group">
        <!-- week buttons -->
      </div>

      <div class="d-flex flex-row my-3 px-1 align-items-center">
        <div id="progGames" class="d-none w-75 ps-1 pe-3">
          <div class="progress-stacked">
            <div id="progPost" class="progress" role="progressbar" style="width: 0%">
              <div class="progress-bar bg-primary"></div>
            </div>
            <div id="progIn" class="progress" role="progressbar" style="width: 0%">
              <div class="progress-bar bg-danger progress-bar-striped progress-bar-animated"></div>
            </div>
            <div id="progPre" class="progress" role="progressbar" style="width: 0%">
              <div class="progress-bar bg-dim"></div>
            </div>
          </div>
        </div>
        <button id="toggle-picks-btn" class="w-25 fw-semibold btn btn-sm btn-primary text-nowrap d-none" type="button" onclick="togglePicks()">Show Picks</button>
      </div>
    </div>
    <div id="tblGames" class="mx-1">

    </div>
    <div id="view-loading" class="container text-center justify-content-center w-75">
      <div class="d-flex column-gap-1 align-items-baseline justify-content-center">
        <h5></h5>
      </div>
      <div class="progress">
        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
      </div>
    </div>
  </div>

  <div class="container text-smaller d-none">
    <pre id="data" class=""></pre>
  </div>
  <script>

    // sendData(refresh = false);

    /* ------------------------------------------------ */

    async function sendData(refresh) {
      setLoadingBar(0);
      setLoadingBar(33, 'Fetching games...');
      const currweek = await getCurrentWeek();
      const games = await getSheet('dbGames');

      setLoadingBar(66, 'Fetching picks...');
      const picks = await getSheet('dbFull');

      let data = procData(games, picks);
      if (refresh == true) {
        setLoadingBar(100, 'Fetching live scores...');
        const livedata = await fetchLive(currweek);
        data = updateData(data, livedata);
      } else {
        setLoadingBar(100, 'Fetching scores...');
      }

      document.getElementById("data").textContent = JSON.stringify(data, undefined, 2);
      // hljs.highlightElement(document.getElementById("data"));
      // console.log(proc);
      setTimeout(function () {
        buildRows();
        filterTable(currweek);
        document.getElementById('view-loading').classList.add('d-none');
        document.getElementById("toggle-picks-btn").classList.remove('d-none');
        document.getElementById("progGames").classList.remove('d-none');
      }, 100);

      setTimeout(function () {
        const tblrows = document.querySelectorAll('.tblrow');
        for (let i = 0; i < tblrows.length; i++) {
          var row = tblrows.item(i);
          row.onclick = function () {
            if (this.querySelector(".pickrow") != null) {
              let picks = this.querySelector(".pickrow");
              let is_shown = picks.classList.contains("hide") == false;
              if (!is_shown) this.querySelector(".pickrow").classList.remove("hide");
              if (is_shown) this.querySelector(".pickrow").classList.add("hide");
            }
          };
        };
      }, 1000);
    }

    function sendOnClick() {
      const tblrows = document.querySelectorAll('.tblrow');
      for (let i = 0; i < tblrows.length; i++) {
        var row = tblrows.item(i);
        row.setAttribute("onclick", 'if (this.querySelector(".pickrow") != null) this.querySelector(".pickrow").classList.remove("hide")');
      };
    }

    function sendOnClick() {
      const tblrows = document.querySelectorAll('.tblrow');
      for (let i = 0; i < tblrows.length; i++) {
        var row = tblrows.item(i);
        row.onclick = function () {
          if (this.querySelector(".pickrow") != null) {
            this.querySelector(".pickrow").classList.remove("hide");
          }
        };
      };
    }


    /* ------------------------------------------------ */

    function make_tblrow(g) {

      let game = make_gamerow_input(g);
      let picks = make_pickrow_input(g);
      let tblrow = new El('div').addClass('tblrow game-' + g.state);

      let gamerow = new El('div').addClass('gamerow row align-items-start pt-2 py-3 mx-0').addStyle('border-top:2px dotted #2f2f2f;');
      gamerow.addChild(new El('div').addClass('col-9 ps-2').addStyle('border-right: 1px solid #2f2f2f;')
        .addChild(new El('div').addClass('d-flex flex-column row-gap-1')
          .addChildren(['away', 'home'].map((team) => {
            return new El('div').addClass('d-flex align-items-center')
              .addChild(game[team].logo.addClass('object-fit-contain').addStyle('height:1.2rem;width:1.2rem;'))
              .addChild(game[team].name.addClass('ps-2 fw-semibold'))
              .addChild(game[team].poss.addClass('object-fit-contain ps-3').addStyle('height:.7rem;width:.7rem;'))
              .addChild(game[team].score.addClass('ms-auto'))
          })
          )
        )
      );
      gamerow.addChild(new El('div').addClass('col-3 pe-1')
        .addChild(new El('div').addClass('d-flex flex-column justify-content-center text-smaller')
          .addChild(game.stat1.addClass('text-dim fw-semibold'))
          .addChild(game.stat2.addClass('text-dim fw-semibold'))
          .addChild(game.odds.addClass('text-dim fw-normal'))
        )
      );

      let pickrow = new El('div').addClass('pickrow hide row align-items-center pt-0 pb-3 mx-0');
      if (picks.length > 0) {
        pickrow.addChild(new El('div').addClass('col-9 ps-1 pe-0')
          .addChild(new El('div').addClass('row row-cols-3 rounded-end-3 bg-dim mx-0 ps-2 pe-1 py-1').addStyle('border-left: 4px solid #0e0e0e')
            .addChildren(picks.map((pick) => {
              return new El('div').addClass('col px-1')
                .addChild(new El('div').addClass('d-flex align-items-center py-1')
                  .addChild(pick.logo.addClass('object-fit-contain').addStyle('height:16px;width:16px;'))
                  .addChild(pick.name.addClass('ps-1 small'))
                )
            })
            )
          )
        );

        tblrow.addChild(gamerow).addChild(pickrow);
      } else {
        tblrow.addChild(gamerow);
      }

      return tblrow;
    }

    /* ------------------------------------------------ */

    function buildRows() {

      const proc = JSON.parse(document.getElementById('data').textContent);

      let rowdata = proc.map((w) => {
        let rows = new El('div').addClass('week-games').addId('week-games-' + w.week);
        let days = w.games.map((x) => x.gameday_long);
        days = days.filter((c, index) => days.indexOf(c) === index);
        days.forEach((d) => {
          rows.addChild(new El('div')
            .addChild(new El('h6').addClass('text-center fw-semibold pt-3 pb-3 mb-0 mt-0 bg-main').addChild(d))
          );

          let games = w.games.filter((x) => x.gameday_long == d);
          games.forEach((g) => rows.addChild(make_tblrow(g)));
        });
        return { week: w.week, games: rows.html() };
      });

      let weeks = rowdata.map((x) => x.week);
      let fCont = document.getElementById('filterCont');
      weeks.forEach((w) => {
        if (!document.getElementById('btn' + w)) {
          let btn = document.createElement('button');
          btn.type = 'button';
          btn.setAttribute('onclick', `filterTable(${w})`);
          btn.classList.add('btn', 'text-dim', 'opacity-50', 'fw-medium', 'text-nowrap', 'rounded-2');
          btn.style.borderColor = 'transparent';
          btn.innerHTML = `Week ${w}`;
          btn.id = 'btn' + w;
          fCont.appendChild(btn);
        }
      });

      let rowSet = rowdata.map((x) => x['games']);
      let rows = [].concat(...rowSet).join('');
      document.getElementById("tblGames").innerHTML = rows;

      // return data;
    }

    /* ------------------------------------------------ */

    function make_gamerow_input(g) {
      let state = g.state;
      let status = g.stateshort;
      let gdate = g.gameday;
      let gtime = g.gametime;
      let odds = g.spread;
      let win_team = g.win_team;
      let info = {};

      ['away', 'home'].forEach((t) => {
        let f_win = g[t + '_team'] == win_team;
        let name = g[t + '_teamshort'];
        let logo = g[t + '_logo'];
        let score = g[t + '_score'];
        let record = g[t + '_record'];

        let elogo = new El('img').addSrc(logo);
        let ename = new El('span').addChild(name)
        if (state == 'post' && !f_win) ename.addClass('opacity-25');

        let eposs = new El('i');
        if (g[t + '_poss']) {
          if (g[t + '_poss'] == '1') {
            eposs.addClass("fa-solid fa-football").addStyle("color: #79552e;");
          }
        }

        let escore = new El('span');
        if (state == 'pre') {
          escore.addChild(record).addClass('text-dim text-smaller');
        } else {
          escore.addChild(score).addClass('fw-semibold');
          if (state == 'post' && !f_win) {
            escore.addClass('opacity-25');
          }
        }

        info[t] = { logo: elogo, name: ename, poss: eposs, score: escore }
      });

      let eodds = new El('span').addChild(odds);
      let estat1 = new El('span');
      let estat2 = new El('span');
      if (state == 'post') {
        estat1.addChild(status)
      } else if (state == 'in') {
        estat1.addChild(status).addStyle('color:#ff5c5c!important');
      } else if (state == 'pre') {
        estat1.addChild(gdate)
        estat2.addChild(gtime)
      }

      info.stat1 = estat1;
      info.stat2 = estat2;
      info.odds = eodds;

      return info;
    }

    /* ------------------------------------------------ */

    function make_pickrow_input(g) {

      if (!g.responses) return [];

      let winner = g.win_team;
      let state = g.state;

      let info = g.responses.map((p) => {
        let status = p.status;
        let pick = p.pick_team;
        let player = p.player;
        let logo = p.pick_logo;

        let elogo = new El('img').addSrc(logo);
        if (pick == '' || status != 'OK') elogo = new El('i');
        let ename = new El('span').addChild(player);

        if (state != 'post') {
          if (pick == '' || status != 'OK') {
            elogo.addClass('opacity-25');
            ename.addClass('opacity-25');
          }
        } else {
          if (status != 'OK' || pick != winner) {
            elogo.addClass('opacity-25');
            ename.addClass('opacity-25');
          }
        }
        return { logo: elogo, name: ename };
      });

      return info;
    }

    /* ------------------------------------------------ */

    function filterTable(week) {

      let togglebtn = document.getElementById('toggle-picks-btn');
      let is_enabled = togglebtn.classList.contains('disabled') == false;
      let picks_on = togglebtn.innerHTML.includes('Hide');

      let tbl = document.getElementById('tblGames');
      let weeks = tbl.getElementsByClassName('week-games');
      let num_prows;
      let num_games;
      let num_pre;
      let num_in;
      let num_post;

      for (let i = 0; i < weeks.length; i++) {
        let wdiv = weeks.item(i);
        let rweek = wdiv.id.replace('week-games-', '');
        let is_week = rweek == week;
        let is_shown = wdiv.classList.contains('hide') == false;
        if (is_week && !is_shown) wdiv.classList.remove('hide');
        if (!is_week && is_shown) wdiv.classList.add('hide');

        if (is_week) {
          num_prows = wdiv.getElementsByClassName('pickrow').length;
          num_games = wdiv.getElementsByClassName('tblrow').length;
          num_pre = wdiv.getElementsByClassName('game-pre').length;
          num_in = wdiv.getElementsByClassName('game-in').length;
          num_post = wdiv.getElementsByClassName('game-post').length;
        }
      }

      if (num_games > 0) {
        let pc_pre = 100 * (num_pre / num_games);
        let pc_in = 100 * (num_in / num_games);
        let pc_post = 100 * (num_post / num_games);
        document.getElementById('progPre').style.width = pc_pre.toString() + '%';
        document.getElementById('progIn').style.width = pc_in.toString() + '%';
        document.getElementById('progPost').style.width = pc_post.toString() + '%';
      }

      if (num_prows == 0) {
        if (is_enabled) togglebtn.classList.add('disabled');
      } else {
        if (!is_enabled) togglebtn.classList.remove('disabled');
      }

      let fCont = document.getElementById('filterCont');
      let btns = fCont.getElementsByClassName('btn');
      for (let j = 0; j < btns.length; j++) {
        btns[j].classList.remove('active');
      }

      let currbtn = document.getElementById('btn' + week);
      currbtn.classList.add('active');
      currbtn.scrollIntoView({ behavior: "smooth", block: "end", inline: "center" });
    }

    /* ------------------------------------------------ */

    function togglePicks() {

      let btn = document.getElementById('toggle-picks-btn');
      let picks_on = btn.innerHTML.includes('Hide') == true;
      if (picks_on == true) btn.innerHTML = 'Show Picks';
      if (picks_on == false) btn.innerHTML = 'Hide Picks';

      let tbl = document.getElementById('tblGames');
      let rows = tbl.getElementsByClassName('pickrow');
      for (let i = 0; i < rows.length; i++) {
        let row = rows.item(i);
        let is_shown = row.classList.contains('hide') == false;
        if (!picks_on) {
          if (!is_shown) row.classList.remove('hide');
        } else {
          if (is_shown) row.classList.add('hide');
        }
      }
    }

    /* ------------------------------------------------ */

    function procData(dbGames, dbFull) {
      let games = dbGames.map((x) => x['game_id']);
      games = games.filter((c, index) => games.indexOf(c) === index);
      let data = games.map((gid) => {
        let gamedata = dbGames.filter((x) => x['game_id'] == gid);
        let game = gamedata[0];
        game.gameday = new Date(game.gametime).toLocaleDateString('en-US', { weekday: 'short', month: 'numeric', day: 'numeric' });
        game.gameday = game.gameday.replace(', ', ' ');
        game.gameday_long = new Date(game.gametime).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
        game.gametime = new Date(game.gametime).toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric' });
        let rec = [
          'espn_id', 'week', 'gameday_long', 'gameday', 'gametime', 'state', 'stateshort',
          'away_team', 'away_teamshort', 'away_record', 'away_logo', 'away_score', 'away_color',
          'home_team', 'home_teamshort', 'home_record', 'home_logo', 'home_score', 'home_color',
          'spread', 'win_team']
          .reduce((obj2, key) => (obj2[key] = game[key], obj2), {});

        let responses = dbFull.filter((x) => x['game_id'] == gid);
        if (responses.length > 1) {
          let resp = responses.map((r) => {
            let pick_color = '';
            let pick_coloralt = '';
            if (r.pick_team == r.away_team) {
              pick_color += r.away_color;
              pick_coloralt += r.away_coloralt;
            }
            if (r.pick_team == r.home_team) {
              pick_color += r.home_color;
              pick_coloralt += r.home_coloralt;
            }
            return {
              player: r.player,
              pick_team: r.pick_team, pick_teamshort: r.pick_teamshort, pick_logo: r.pick_logo, pick_color: pick_color, pick_coloralt: pick_coloralt,
              status: r.status
            }
          });
          rec['responses'] = resp;
        }
        if (rec.stateshort.split(' - ')[0] == 'TBD') rec.stateshort = 'TBD';
        return rec;
      });

      let weeks = data.map((x) => x['week']);
      weeks = weeks.filter((c, index) => weeks.indexOf(c) === index);
      let weeklydata = weeks.map((w) => {
        let games = data.filter((x) => x['week'] == w);
        return {
          week: w,
          games: games
        }
      });

      return weeklydata;
    }

    /* ------------------------------------------------ */

    async function fetchLive(week) {

      console.log('FETCHING LIVE');
      const resp = await fetch('https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard?seasontype=2&dates=2023&week=' + week);
      const raw = await resp.text();
      const events = JSON.parse(raw)['events'];

      const proc = events.map((game) => {

        let comp = game.competitions[0];
        let hid = comp.competitors[0].id;
        let aid = comp.competitors[1].id;

        let data = {};
        data.espn_id = game.id;
        data.week = game.week.number;
        data.home_score = game.competitions[0].competitors[0].score;
        data.away_score = game.competitions[0].competitors[1].score;
        data.state = game.status.type.state;
        data.stateshort = game.status.type.shortDetail;
        data.home_poss = '0';
        data.away_poss = '0';

        if (comp.situation) {
          if (comp.situation.possession) {
            let pid = comp.situation.possession;
            if (pid == hid) data.home_poss = '1';
            if (pid == aid) data.away_poss = '1';
          }
        }

        return data;
      });

      console.log(proc);
      return proc;
    }

    /* ------------------------------------------------ */

    function updateData(proc, live) {
      console.log('UPDATING LIVE');
      let week = live[0].week.toString();
      let data = proc.map((w) => {
        if (w.week == week) {
          w.games = w.games.map((game) => {
            let g = game;
            let glive = live.filter((x) => x.espn_id == g.espn_id)[0];
            console.log(g);
            console.log(glive);
            g.away_score = glive.away_score;
            g.home_score = glive.home_score;
            g.state = glive.state;
            g.stateshort = glive.stateshort;
            g.away_poss = glive.away_poss;
            g.home_poss = glive.home_poss;
            let ascore = parseInt(glive.away_score);
            let hscore = parseInt(glive.home_score);

            if (g.state == 'post') {
              if (ascore > hscore) {
                g.win_team = g.away_team;
              } else if (hscore > ascore) {
                g.win_team = g.home_team;
              } else {
                g.win_team = 'TIE';
              }
            }
            return g;
          });
        }
        return w;
      });

      console.log(data);
      return data;
    }

    /* ------------------------------------------------ */

    function setLoadingBar(value, task, close = false) {
      const div = document.getElementById('view-loading');
      const bar = div.querySelector('.progress-bar');
      const text = div.querySelector('h5');
      if (value) bar.style.width = value + '%';
      if (task) text.innerHTML = task;
    }

    /* ------------------------------------------------ */

    async function getCurrentWeek() {
      let forms = await getSheet('Info');
      forms.reverse();
      let currweek = forms[0]['Form'].split(' ')[1];
      return currweek;
    }

    /* ------------------------------------------------ */

    async function getSheet(sheet) {
      const shname = sheet.split(' ').join('+');
      const resp = await fetch('https://docs.google.com/spreadsheets/d/14ZYopWScY-nkBJ4Eq7DpLqRw6s2Fre3EWYkKsCIc8lU/gviz/tq?tqx=out:json&tq&sheet=' + shname);
      const raw = await resp.text();
      const data = procSheet(raw);

      return data;
    }

  </script>
  <script src="https://cdn.jsdelivr.net/gh/jordan-ewings/pickem@main/scripts/base.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous">
  </script>
</body>

</html>